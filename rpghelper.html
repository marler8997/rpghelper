<!DOCTYPE html>
<html><head>
<title>rpghelper</title>
<style type="text/css">

* {margin:0;padding:0}
.tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px #aaa;
}

.tooltip .tooltiptext {
  visibility: hidden;
  background-color: #eee;
  color: #222;
  border-radius: 6px;
  padding: 15px;
  font-size: 15px;

  /* Position the tooltip */
  position: absolute;
  z-index: 1;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
}

</style>
</head><body>
<input type="file" id="ConfigFileInput" name="file" />
<pre id="LoadFileErrorPre" style="color:#a00"></pre>
<pre id="LoadFileStatusPre"></pre>
<div>
    <h1>Character</h1>
    <pre id="CharacterPre"></pre>
</div>
<hr/>
<div>
    <h1>Ops</h1>
    <pre id="OpsPre"></pre>
</div>

<script>

function get(id) { return document.getElementById(id); }

var attrs = [
    "strength",
    "dexterity",
    "constitution",
    "intelligence",
    "wisdom",
    "charisma"
];


function renderTooltip(content, tooltip) {
    return '<div class="tooltip">' + content +
        '<span class="tooltiptext">' + tooltip + '</span>';
}

function render(data) {
    html = ''
        + '<h1>Name: ' + data.name + '</h1>'
        + '<h1>HP: ' + data.hp.current + " / "
            + renderTooltip(data.hp.max, '<pre>' + opsToTextBlock(data.hp.ops) + '</pre>')
        + '</h1>'
        + '<h3>Speed: ' + renderTooltip(data.speed.value,  opsToTextBlock(data.speed.ops)) + '</h3>'
        ;
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    // TODO: make this a table or datagrid or something
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    var i = 0;
    for (i = 0; i < attrs.length; i++) {
        var attr = attrs[i];
        var attrObj = data[attr];
        var modifier = Math.floor( (attrObj.value - 10) / 2);
        html += ''
            + '<h1>' +
                renderTooltip(attr + ': ' + modifier + '  (score=' + attrObj.value + ')',
                    '<pre>' + opsToTextBlock(attrObj.ops) + '</pre>')
            + '</h1>'
            ;
    }
    get('CharacterPre').innerHTML = html;
    get('OpsPre').innerHTML = opsToTextBlock(data.ops);
}

function opsToTextBlock(ops) {
    if (ops.length == 0) return "No Operations";
    var text = '';
    var i = 0;
    for (i = 0; i < ops.length; i++) {
        text += JSON.stringify(ops[i]) + '\n';
    }
    return text;
}

function setLoadStatus(msg) {
    get('LoadFileErrorPre').innerText = '';
    get('LoadFileStatusPre').innerText = msg;
}
function setLoadError(msg) {
    get('LoadFileErrorPre').innerText = 'ERROR: ' + msg;
    get('LoadFileStatusPre').innerText = '';
}

function BadConfigException(message) {
    return new Error(message);
}
BadConfigException.prototype = Object.create(Error.prototype);

function enforceProp(obj, name, context) {
    if (name in obj) { return obj[name]; }
    throw new BadConfigException(context + ', missing the "' + name + '" attribute')
}

function loadData(jsonData) {
    setLoadStatus('parsing config...');
    try {
        var context = 'At the top-level';
        var system = enforceProp(jsonData, 'system', context);
        if (system == 'Pathfinder2e') {
            // good
        } else {
            throw new BadConfigException('unknown System "' + system + '"');
        }
        var name = enforceProp(jsonData, 'name', context);
        var processedData = {
            "name":name,
            "hp": {
                "max": 0,
                "current": 0,
                ops: []
            },
            "speed": {"value":0,ops:[]},
            ops:jsonData.ops
        };
        var i = 0;
        for (i = 0; i < attrs.length; i++) {
            processedData[attrs[i]] = {"value":10, ops:[]};
        }
        var ops = enforceProp(jsonData, 'ops', context);
        var i = 0;
        for (i = 0; i < ops.length; i++) {
            processOp(processedData, ops[i]);
        }
    } catch (e) {
        setLoadError(e.message);
        return
    }
    setLoadStatus('');
    render(processedData);
}

function processOp(processedData, op)
{
    type = enforceProp(op, 'type', 'Inside an op');
    context = "Inside op type '" + type + "'";

    var i = 0;
    for (i = 0; i < attrs.length; i++) {
        var attr = attrs[i];
        if (type == attrs[i]) {
            var mod = enforceProp(op, 'mod', context);
            var reason = enforceProp(op, 'reason', context);
            processedData[attr].value += mod;
            processedData[attr].ops.push(op);
            return;
        }
    }
    if (false) {
    } else if (type == 'hp') {
        var mod = enforceProp(op, 'mod', context);
        var reason = enforceProp(op, 'reason', context);
        processedData.hp.max += mod;
        processedData.hp.current += mod;
        processedData.hp.ops.push(op);
    } else if (type == 'speed') {
        var value = enforceProp(op, 'value', context);
        var reason = enforceProp(op, 'reason', context);
        processedData.speed.value = value;
        processedData.speed.ops.push(op);
    } else {
        throw new BadConfigException('unknown op type "' + type + '"');
    }
}

function configFileSelect(evt) {
    var reader = new FileReader();
    reader.onerror = function errorHandler(evt) {
        switch(evt.target.error.code) {
        case evt.target.error.NOT_FOUND_ERR:
            setLoadError('File Not Found!');
            break;
        case evt.target.error.NOT_READABLE_ERR:
            setLoadError('File is not readable');
            break;
        case evt.target.error.ABORT_ERR:
            break; // noop
        default:
            setLoadError('An error occurred reading this file.');
        };
    };
    reader.onloadstart = function(e) {
        setLoadStatus('loading...');
    };
    reader.onload = function(e) {
        var data;
        try { data = JSON.parse(e.target.result); }
        catch (e) { alert(e); }
        loadData(data);
    }
    reader.readAsText(evt.target.files[0]);
}

document.getElementById('ConfigFileInput').addEventListener('change', configFileSelect, false);
</script>
</body></html>